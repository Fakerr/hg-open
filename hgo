#!/usr/bin/env bash


set -e

version="0.0.1"
BRANCH=false
COMMIT=false
DIRECTORY=""

# parse options
while [[ "$1" =~ ^- && ! "$1" == "--" ]]; do
  case $1 in
    -v | --version )
      echo $version
      exit
      ;;
    -d | --directory )
      DIRECTORY="$2"
      shift;
      ;;
    -b | --branch )
      BRANCH=true
      COMMIT=false
      ;;
    -c | --commit )
      COMMIT=true
      BRANCH=false
      ;;
    * )
      echo "abort: unknown argument" 1>&2
      exit 1
  esac
  shift
done
if [[ "$1" == "--" ]]; then shift; fi


# go under the selected directory
if [ -n "$DIRECTORY" ]; then
  cd $DIRECTORY &> /dev/null
fi

# are we in a mercurial repo?
if [ ! -d ".hg" ]; then
  echo "abort: not a mercurial repository." 1>&2
  exit 1
fi

# get remote (default remote)
# TODO allow users to choose the remote
remote=$(hg paths default)

# set remote url
# TODO handle all available services
if [ ${remote:0:3} = 'ssh' ] || [ ${remote:0:5} = 'https' ]; then
    url="https://bitbucket.org/${remote##*org\/}"
fi

# open according arguments
if [[ $BRANCH = true ]]; then
  branch=$(hg branch)
  url+="/branch/$branch"
elif [[ $COMMIT = true ]]; then
  url+="/commits/all"
fi

# get current open browser command
case $( uname -s ) in
  Darwin)  open=open;;
  MINGW*)  open=start;;
  CYGWIN*) open=cygstart;;
  MSYS*)   open="powershell.exe â€“NoProfile Start";;
  *)       open=${BROWSER:-xdg-open};;
esac

# open it in a browser
$open "$url" &> /dev/null
exit 0
